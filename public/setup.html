<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArtStream - Set Up Your Stream</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');

        :root {
            --bg-primary: #0f0f1a;
            --bg-secondary: #1a1a2e;
            --accent-primary: #3a0ca3;
            --accent-secondary: #4361ee;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }

        .bg-gradient {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
        }

        .form-input {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        .form-input:focus {
            border-color: var(--accent-secondary);
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.3);
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-secondary);
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--accent-secondary);
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .artistic-bg {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Cg fill-rule='evenodd'%3E%3Cg fill='%239C92AC' fill-opacity='0.1'%3E%3Cpath opacity='.5' d='M96 95h4v1h-4v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9zm-1 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9z'/%3E%3Cpath d='M6 5V0H5v5H0v1h5v94h1V6h94V5H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
    </style>
</head>
<body class="min-h-screen artistic-bg" x-data="setupData()">
    <div class="flex h-screen">
        <!-- Main Content -->
        <div class="flex-1 p-8 overflow-y-auto">
            <header class="text-center mb-12">
                <h1 class="text-5xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-600">Set Up Your Stream</h1>
                <p class="text-xl text-gray-400">Configure your live art experience</p>
            </header>

            <form @submit.prevent="submitForm" class="space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="space-y-6">
                        <div>
                            <label class="block mb-2 font-semibold text-gray-300" for="streamName">
                                <i class="fas fa-video mr-2 text-blue-400"></i>Stream Name
                            </label>
                            <input id="streamName" x-model="streamName" type="text" placeholder="Enter your stream name" class="w-full p-3 rounded-md form-input">
                        </div>

                        <div>
                            <label class="block mb-2 font-semibold text-gray-300" for="streamCategory">
                                <i class="fas fa-tags mr-2 text-blue-400"></i>Stream Category
                            </label>
                            <select id="streamCategory" x-model="streamCategory" class="w-full p-3 rounded-md form-input">
                                <option value="">Select a category</option>
                                <option value="Art">Art</option>
                                <option value="Music">Music</option>
                                <option value="Stand-Up">Stand-Up</option>
                                <option value="Acting">Acting</option>
                                <option value="other">Other</option>
                            </select>
                        </div>

                        <div>
                            <label class="block mb-2 font-semibold text-gray-300" for="streamDescription">
                                <i class="fas fa-info-circle mr-2 text-blue-400"></i>Stream Description
                            </label>
                            <textarea id="streamDescription" x-model="streamDescription" placeholder="Describe your stream..." class="w-full p-3 rounded-md form-input" rows="4"></textarea>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <div>
                            <label class="block mb-2 font-semibold text-gray-300">
                                <i class="fas fa-users mr-2 text-blue-400"></i>Max Number of Artists
                            </label>
                            <input type="range" x-model="maxArtists" min="2" max="15" step="1" class="w-full bg-gradient">
                            <span class="block mt-2 text-sm text-gray-400">Current: <span x-text="maxArtists"></span> artists</span>
                        </div>

                        <div>
                            <label class="block mb-2 font-semibold text-gray-300">
                                <i class="fas fa-clock mr-2 text-blue-400"></i>Estimated Duration
                            </label>
                            <select x-model="estimatedDuration" class="w-full p-3 rounded-md form-input">
                                <option value="30">30 minutes</option>
                                <option value="60">1 hour</option>
                                <option value="90">1.5 hours</option>
                                <option value="120">2 hours</option>
                                <option value="180">3 hours</option>
                                <option value="240">4+ hours</option>
                            </select>
                        </div>

                        <div class="flex items-center space-x-4">
                            <label class="switch">
                                <input type="checkbox" x-model="isScheduled">
                                <span class="slider"></span>
                            </label>
                            <span class="font-semibold text-gray-300">Schedule for Later</span>
                        </div>

                        <div x-show="isScheduled" x-transition class="mt-4">
                            <label class="block mb-2 font-semibold text-gray-300" for="scheduleTime">
                                <i class="far fa-calendar-alt mr-2 text-blue-400"></i>Start Time
                            </label>
                            <input id="scheduleTime" x-model="scheduleTime" type="text" placeholder="Select date and time" class="w-full p-3 rounded-md form-input">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <button type="button" @click="testCamera" class="w-full p-3 rounded-md bg-gradient text-white font-bold transition duration-300 ease-in-out transform hover:-translate-y-1 hover:shadow-lg">
                        <i class="fas fa-camera mr-2"></i>Test Camera
                    </button>
                    <button type="button" @click="testMicrophone" class="w-full p-3 rounded-md bg-gradient text-white font-bold transition duration-300 ease-in-out transform hover:-translate-y-1 hover:shadow-lg">
                        <i class="fas fa-microphone mr-2"></i>Test Microphone
                    </button>
                </div>

                <div x-show="showCameraPreview" class="mt-4 relative">
                    <video id="cameraPreview" class="w-full rounded-md"></video>
                    <button @click="closeCameraPreview" class="absolute top-2 right-2 bg-red-500 hover:bg-red-600 text-white rounded-full p-2 focus:outline-none focus:ring-2 focus:ring-red-400">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div x-show="showMicrophonePreview" class="mt-4 relative">
                    <div class="audio-visualizer bg-gray-700 h-16 rounded-md overflow-hidden flex items-end">
                        <template x-for="i in 50">
                            <div class="audio-bar bg-blue-400 w-1" :style="{ height: audioLevels[i-1] + '%' }"></div>
                        </template>
                    </div>
                    <button @click="closeMicrophonePreview" class="absolute top-2 right-2 bg-red-500 hover:bg-red-600 text-white rounded-full p-2 focus:outline-none focus:ring-2 focus:ring-red-400">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="space-y-4">
                    <h2 class="text-xl font-semibold text-gray-300">Stream Settings</h2>
                    <div class="flex items-center justify-between">
                        <span class="text-gray-400">Enable Chat</span>
                        <label class="switch">
                            <input type="checkbox" x-model="enableChat">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-gray-400">Private Stream</span>
                        <label class="switch">
                            <input type="checkbox" x-model="isPrivate">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <p class="text-sm text-gray-500" x-show="!isPrivate">
                        Anyone can join this stream.
                    </p>
                    <p class="text-sm text-gray-500" x-show="isPrivate">
                        Only artists with the stream key can join.
                    </p>
                </div>

                <button type="submit" class="w-full p-4 rounded-md bg-gradient text-white font-bold text-lg transition duration-300 ease-in-out transform hover:-translate-y-1 hover:shadow-xl">
                    <span x-text="isScheduled ? 'Schedule Stream' : 'Start Server'"></span>
                </button>
            </form>
        </div>

        <!-- Side Panel -->
        <div class="w-1/4 bg-gray-800 p-8 overflow-y-auto">
            <h2 class="text-2xl font-bold mb-6 text-gray-300">Stream Preview</h2>
            <div class="bg-gray-700 rounded-lg p-4 mb-6">
                <h3 class="text-xl font-semibold mb-2" x-text="streamName || 'Your Stream Name'"></h3>
                <p class="text-sm text-gray-400 mb-2" x-text="streamCategory || 'Category'"></p>
                <p class="text-sm text-gray-400" x-text="streamDescription || 'Your stream description will appear here...'"></p>
            </div>

            <h2 class="text-2xl font-bold mb-6 text-gray-300">Quick Tips</h2>
            <ul class="list-disc list-inside text-gray-400 space-y-2">
                <li>Ensure good lighting for your stream</li>
                <li>Test your audio before going live</li>
                <li>Interact with your audience regularly</li>
                <li>Have all your art supplies ready</li>
                <li>Take short breaks during long streams</li>
            </ul>

            <div class="mt-8">
                <h2 class="text-2xl font-bold mb-6 text-gray-300">Streaming Stats</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-700 rounded-lg p-4 text-center">
                        <p class="text-sm text-gray-400">Total Streams</p>
                        <p class="text-2xl font-bold text-blue-400">24</p>
                    </div>
                    <div class="bg-gray-700 rounded-lg p-4 text-center">
                        <p class="text-sm text-gray-400">Followers</p>
                        <p class="text-2xl font-bold text-purple-400">1.2K</p>
                    </div>
                    <div class="bg-gray-700 rounded-lg p-4 text-center">
                        <p class="text-sm text-gray-400">Avg. Viewers</p>
                        <p class="text-2xl font-bold text-green-400">150</p>
                    </div>
                    <div class="bg-gray-700 rounded-lg p-4 text-center">
                        <p class="text-sm text-gray-400">Stream Time</p>
                        <p class="text-2xl font-bold text-red-400">48h</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function setupData() {
            return {
                streamName: '',
                streamDescription: '',
                streamCategory: '',
                maxArtists: 2,
                estimatedDuration: '60',
                isScheduled: false,
                scheduleTime: '',
                enableChat: true,
                showCameraPreview: false,
                showMicrophonePreview: false,
                audioLevels: Array(50).fill(0),
                audioContext: null,
                audioStream: null,
                isPrivate: false,
                async submitForm() {
                    const hostName = localStorage.getItem('username');
                    const formData = {
                        name: this.streamName,
                        description: this.streamDescription,
                        category: this.streamCategory,
                        maxArtists: parseInt(this.maxArtists),
                        estimatedDuration: this.estimatedDuration,
                        chatEnabled: this.enableChat,
                        isPrivate: this.isPrivate,
                        hostName: hostName
                    };

                    try {
                        const token = localStorage.getItem('token');
                        if (!token) {
                            throw new Error('No authentication token found');
                        }

                        const response = await fetch('http://localhost:3000/streams', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify(formData)
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(`Failed to create stream: ${errorData.message || response.statusText}`);
                        }

                        const stream = await response.json();
                        localStorage.setItem('currentStreamId', stream._id);
                        window.location.href = 'waiting.html';
                    } catch (error) {
                        console.error('Error creating stream:', error);
                        alert(`Failed to create stream: ${error.message}`);
                    }
                },
                async testCamera() {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                        const video = document.getElementById('cameraPreview');
                        video.srcObject = stream;
                        video.play();
                        this.showCameraPreview = true;
                    } catch (error) {
                        console.error('Error accessing camera:', error);
                        alert('Unable to access camera. Please check your permissions.');
                    }
                },
                closeCameraPreview() {
                    const video = document.getElementById('cameraPreview');
                    const stream = video.srcObject;
                    const tracks = stream.getTracks();
                    tracks.forEach(track => track.stop());
                    this.showCameraPreview = false;
                },
                async testMicrophone() {
                    try {
                        this.audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        const source = this.audioContext.createMediaStreamSource(this.audioStream);
                        const analyser = this.audioContext.createAnalyser();
                        analyser.fftSize = 256;
                        source.connect(analyser);
                        
                        const updateAudioLevels = () => {
                            const dataArray = new Uint8Array(analyser.frequencyBinCount);
                            analyser.getByteFrequencyData(dataArray);
                            this.audioLevels = Array.from(dataArray.slice(0, 50)).map(value => value / 2);
                            if (this.showMicrophonePreview) {
                                requestAnimationFrame(updateAudioLevels);
                            }
                        };
                        
                        this.showMicrophonePreview = true;
                        updateAudioLevels();
                    } catch (error) {
                        console.error('Error accessing microphone:', error);
                        alert('Unable to access microphone. Please check your permissions.');
                    }
                },
                closeMicrophonePreview() {
                    if (this.audioStream) {
                        this.audioStream.getTracks().forEach(track => track.stop());
                    }
                    if (this.audioContext) {
                        this.audioContext.close();
                    }
                    this.showMicrophonePreview = false;
                }
            }
        }

        document.addEventListener('alpine:init', () => {
            flatpickr("#scheduleTime", {
                enableTime: true,
                dateFormat: "Y-m-d H:i",
                minDate: "today",
                theme: "dark"
            });
        });
    </script>
</body>
</html>