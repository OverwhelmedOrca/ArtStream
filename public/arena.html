<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Art Battle Arena</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/2.3.0/alpine.js" integrity="sha512-nIwdJlD5/vHj23CbO2iHCXtsqzdTTx3e3uAmpTm4x2Y8xCIFyWu4cSIV8GaGe2UNVq86/1h9EgUZy7tn243qdA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@2.8.2/dist/alpine.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #111827;
            color: #e2e8f0;
        }
        .card {
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(59, 130, 246, 0.4);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #4338ca, #3b82f6);
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="bg-gray-900 text-white" x-data="arenaApp()">
    <header class="bg-gray-900 p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-3xl font-bold text-blue-400">Art Battle Arena</h1>
            <div class="relative" x-data="{ open: false, username: '' }" x-init="username = localStorage.getItem('username') || 'default'">
                <img :src="'https://i.pravatar.cc/150?u=' + username" class="w-10 h-10 rounded-full cursor-pointer border-2 border-blue-400" @click="open = !open">
                <div x-show="open" @click.away="open = false" class="absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-gray-800 ring-1 ring-black ring-opacity-5">
                    <div class="py-1" role="menu">
                        <a href="#" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white" role="menuitem">Profile</a>
                        <a href="#" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white" role="menuitem">Settings</a>
                        <a href="#" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white" role="menuitem">Logout</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-12" role="main">
        <h2 class="text-4xl font-bold mb-8 text-center text-blue-400">Choose Your Arena</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <!-- Arena cards -->
            <template x-for="arena in arenas" :key="arena.name">
                <div class="card bg-gray-800 rounded-lg overflow-hidden shadow-lg">
                    <img :src="arena.image" :alt="arena.name" class="w-full h-48 object-cover">
                    <div class="p-6">
                        <h3 x-text="arena.name" class="text-2xl font-bold mb-2 text-blue-400"></h3>
                        <p class="mb-4">Stake: $<span x-text="arena.stake"></span></p>
                        <p x-text="arena.description" class="mb-4"></p>
                        <button @click="enterArena(arena)" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
                            Enter Arena
                        </button>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- Modal -->
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" x-show="showModal" x-cloak>
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl max-w-md w-full">
            <h3 class="text-2xl font-bold mb-4 text-blue-400">Battle Options</h3>
            <div class="mb-4">
                <label class="flex items-center">
                    <input type="checkbox" x-model="aiAllowed" class="form-checkbox h-5 w-5 text-blue-600">
                    <span class="ml-2 text-gray-300">Allow use of AI</span>
                </label>
            </div>
            <div class="mb-4">
                <label class="flex items-center">
                    <input type="checkbox" x-model="liveStream" class="form-checkbox h-5 w-5 text-blue-600">
                    <span class="ml-2 text-gray-300">Live stream the battle</span>
                </label>
            </div>
            <div class="mb-4">
                <label class="block text-gray-300 mb-2">Time Limit</label>
                <select x-model="timeLimit" class="form-select w-full bg-gray-700 text-white rounded">
                    <option value="5">5 minutes</option>
                    <option value="10">10 minutes</option>
                    <option value="30">30 minutes</option>
                    <option value="60">60 minutes</option>
                </select>
            </div>
            <button @click="findOpponent()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
                Find Opponent
            </button>
            <button @click="showModal = false" class="mt-4 text-gray-400 hover:text-white">
                Cancel
            </button>
        </div>
    </div>

    <!-- Modal for waiting for opponent -->
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" x-show="showLoading" x-cloak>
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl max-w-md w-full text-center">
            <svg class="animate-spin h-12 w-12 text-blue-600 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <h3 class="text-2xl font-bold mb-2 text-blue-400">Waiting for Opponent</h3>
            <p class="text-gray-300">Hang tight while we find your perfect match!</p>
        </div>
    </div>

    <!-- Modal for opponent found -->
    <div x-show="showOpponentModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl max-w-md w-full text-center">
            <img :src="opponentAvatar" alt="Opponent" class="w-24 h-24 rounded-full mx-auto mb-4">
            <h3 class="text-2xl font-bold mb-2 text-blue-400">Opponent Found!</h3>
            <p class="text-gray-300">You'll be battling against <span x-text="opponentName" class="font-bold"></span></p>
            <p id="redirectMessage" class="text-gray-400 mt-4"></p>
        </div>
    </div>

    <script>
        function arenaApp() {
            return {
                showModal: false,
                showLoading: false,
                showOpponentModal: false,
                currentArena: null,
                aiAllowed: false,
                liveStream: false,
                timeLimit: '10',
                opponentName: '',
                opponentAvatar: '',
                battleId: null,
                arenas: [
                    {
                        name: "Friendly Skirmish",
                        stake: 0,
                        image: "https://images.unsplash.com/photo-1460661419201-fd4cecdf8a8b?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=800&q=80",
                        description: "Unleash your creativity without breaking the bank. Perfect for warming up those artistic muscles!"
                    },
                    {
                        name: "Street Showdown",
                        stake: 2,
                        image: "https://images.unsplash.com/photo-1561214115-f2f134cc4912?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=800&q=80",
                        description: "Bring your A-game to the streets. Show 'em what you've got for the price of a coffee!"
                    },
                    {
                        name: "Gallery Grudge",
                        stake: 5,
                        image: "https://images.unsplash.com/photo-1513364776144-60967b0f800f?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=800&q=80",
                        description: "Step it up a notch. Your art might just end up on someone's wall... or their meme collection!"
                    },
                    {
                        name: "Canvas Clash",
                        stake: 10,
                        image: "https://images.unsplash.com/photo-1579783902614-a3fb3927b6a5?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=800&q=80",
                        description: "Getting serious now. Time to show those brushes who's boss!"
                    },
                    {
                        name: "Masterpiece Mayhem",
                        stake: 25,
                        image: "https://images.unsplash.com/photo-1501084817091-a4f3d1d19e07?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=800&q=80",
                        description: "The big leagues. Your art vs theirs. May the best masterpiece win!"
                    },
                    {
                        name: "Louvre Legends",
                        stake: 100,
                        image: "https://images.unsplash.com/photo-1567095761054-7a02e69e5c43?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8YWJzdHJhY3QlMjBzY3VscHR1cmV8ZW58MHx8MHx8fDA%3D",
                        description: "The ultimate showdown. Winner gets a spot next to Mona Lisa... well, almost!"
                    }
                ],

                enterArena(arena) {
                    this.currentArena = arena;
                    this.showModal = true;
                },

                async findOpponent() {
                    this.showModal = false;
                    this.showLoading = true;
                    this.battleId = null; // Reset battleId

                    const battleData = {
                        username: localStorage.getItem('username'),
                        arenaName: this.currentArena.name,
                        stakeAmount: this.currentArena.stake,
                        aiAllowed: this.aiAllowed,
                        liveStream: this.liveStream,
                        timeLimit: parseInt(this.timeLimit)
                    };

                    try {
                        const response = await fetch('/api/find-opponent', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            },
                            body: JSON.stringify(battleData)
                        });

                        if (!response.ok) {
                            throw new Error('Failed to find opponent');
                        }

                        const result = await response.json();

                        if (result.opponentFound) {
                            this.showOpponentFound(result.opponent);
                        } else {
                            this.battleId = result.battleId;
                            this.checkForOpponent();
                        }
                    } catch (error) {
                        console.error('Error finding opponent:', error);
                        this.showLoading = false;
                        // Show error message to user
                    }
                },

                async checkForOpponent() {
                    if (!this.battleId) {
                        this.showLoading = false;
                        return;
                    }

                    try {
                        const response = await fetch(`/api/check-opponent/${this.battleId}`, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            }
                        });

                        if (!response.ok) {
                            throw new Error('Failed to check for opponent');
                        }

                        const result = await response.json();

                        if (result.opponentFound) {
                            this.showOpponentFound(result.opponent);
                        } else {
                            // Keep checking every 5 seconds
                            setTimeout(() => this.checkForOpponent(), 5000);
                        }
                    } catch (error) {
                        console.error('Error checking for opponent:', error);
                        this.showLoading = false;
                        // Show error message to user
                    }
                },

                async showOpponentFound(opponent) {
                    this.showLoading = false;
                    this.showOpponentModal = true;
                    this.opponentName = opponent.username;
                    this.opponentAvatar = `https://i.pravatar.cc/150?u=${opponent.username}`;
                    
                    const redirectMessage = this.liveStream ? "Setting up live stream... \n (it can take a few seconds)" : "Redirecting to battle...";
                    const redirectElement = document.getElementById('redirectMessage');
                    if (redirectElement) {
                        redirectElement.textContent = redirectMessage;
                    }

                    try {
                        if (this.liveStream) {
                            await this.setupLiveStream();
                        }
                    } catch (error) {
                        console.error('Error setting up live stream:', error);
                        alert(`Failed to set up live stream: ${error.message}. Continuing to battle without live stream.`);
                    }

                    // Store battle information in localStorage
                    localStorage.setItem('battleId', this.battleId);
                    localStorage.setItem('aiAllowed', this.aiAllowed);
                    localStorage.setItem('timeLimit', this.timeLimit);
                    localStorage.setItem('arenaName', this.currentArena.name);

                    // Redirect after 3 seconds
                    setTimeout(() => {
                        window.location.href = `/instructions.html?id=${this.battleId}`;
                    }, 3000);
                },

                async setupLiveStream() {
                    try {
                        console.log('Creating new livestream...');
                        const streamName = `${this.currentArena.name} Battle: ${localStorage.getItem('username')} vs ${this.opponentName}`;
                        const createStreamResponse = await axios.post('https://api.thetavideoapi.com/stream', 
                            { name: streamName },
                            {
                                headers: {
                                    'x-tva-sa-id': 'srvacc_uaef6ix91e360bvt2zw31n2hf',
                                    'x-tva-sa-secret': '231c167vuc8d1ik6i3yhkqt5y404v0wb',
                                    'Content-Type': 'application/json'
                                }
                            }
                        );
                        console.log('Create stream response:', createStreamResponse.data);

                        const streamId = createStreamResponse.data.body.id;
                        console.log('Stream ID:', streamId);

                        console.log('Listing ingestors...');
                        const ingestorsResponse = await axios.get('https://api.thetavideoapi.com/ingestor/filter', {
                            headers: {
                                'x-tva-sa-id': 'srvacc_uaef6ix91e360bvt2zw31n2hf',
                                'x-tva-sa-secret': '231c167vuc8d1ik6i3yhkqt5y404v0wb'
                            }
                        });
                        console.log('Ingestors response:', ingestorsResponse.data);

                        const ingestorId = ingestorsResponse.data.body.ingestors[0].id;
                        console.log('Selected ingestor ID:', ingestorId);

                        console.log('Selecting ingestor...');
                        const selectIngestorResponse = await axios.put(`https://api.thetavideoapi.com/ingestor/${ingestorId}/select`,
                            { tva_stream: streamId },
                            {
                                headers: {
                                    'x-tva-sa-id': 'srvacc_uaef6ix91e360bvt2zw31n2hf',
                                    'x-tva-sa-secret': '231c167vuc8d1ik6i3yhkqt5y404v0wb',
                                    'Content-Type': 'application/json'
                                }
                            }
                        );
                        console.log('Select ingestor response:', selectIngestorResponse.data);

                        const { stream_server, stream_key } = selectIngestorResponse.data.body;
                        console.log('Stream server:', stream_server);
                        console.log('Stream key:', stream_key);

                        localStorage.setItem('streamId', streamId);
                        localStorage.setItem('streamServer', stream_server);
                        localStorage.setItem('streamKey', stream_key);
                        console.log('Stream info saved to localStorage');

                    } catch (error) {
                        console.error('Error setting up live stream:', error);
                        throw error; // Rethrow the error to be caught in the calling function
                    }
                }
            }
        }
    </script>

</body>
</html>